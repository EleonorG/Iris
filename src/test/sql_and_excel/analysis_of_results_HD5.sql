-- count result of all comparisons using interval
-- from 0.0 to 0.29 for same or identical irises, and from 0.37 to 0.50 for different irises
WITH 
PARAM AS (
	SELECT 0 SAME_MIN, 0.30 SAME_MAX, 0.40 DIFF_MIN, 0.5 DIFF_MAX, 12 PERSON_MAX, 8 PHOTO_MAX 
),
PHOTOS AS (
    SELECT SUBSTRING(PHOTO1,1,5) IRIS1, PHOTO1, SUBSTRING(PHOTO2,1,5) IRIS2, PHOTO2, HD,  
    CASE WHEN HD BETWEEN P.SAME_MIN AND P.SAME_MAX THEN 'SAME' WHEN HD BETWEEN P.DIFF_MIN AND DIFF_MAX THEN 'DIFFERENT' ELSE 'INCONCLUSIVE' END RESULT 
    FROM HD_TEST I, PARAM P
    WHERE CONVERT(NUMERIC,SUBSTRING(PHOTO1,3,3))<PERSON_MAX AND CONVERT(NUMERIC,SUBSTRING(PHOTO2,3,3))<PERSON_MAX AND CONVERT(NUMERIC,SUBSTRING(PHOTO1,7,2))<PHOTO_MAX AND CONVERT(NUMERIC,SUBSTRING(PHOTO2,7,2))<PHOTO_MAX
),
-- Iris on photo is identified as same, if the result of comparison with photos of iris is in majority equal 'SAME'
-- Iris on photo is identified as different, if the result of comparison with photos of iris is in majority equal 'DIFFERENT'
PHOTO_RES AS (
SELECT DISTINCT PHOTO1, IRIS1, IRIS2, SUM(HD)/COUNT(*) AS PCT, 
CASE WHEN (SELECT COUNT(*) FROM PHOTOS J WHERE J.PHOTO1=I.PHOTO1 AND J.IRIS2=I.IRIS2 AND J.RESULT='SAME')>(SELECT COUNT(*) FROM PHOTOS J WHERE J.PHOTO1=I.PHOTO1 AND J.IRIS2=I.IRIS2)/2 THEN 'SAME'
     WHEN (SELECT COUNT(*) FROM PHOTOS J WHERE J.PHOTO1=I.PHOTO1 AND J.IRIS2=I.IRIS2 AND J.RESULT='DIFFERENT')>(SELECT COUNT(*) FROM PHOTOS J WHERE J.PHOTO1=I.PHOTO1 AND J.IRIS2=I.IRIS2)/2 THEN 'DIFFERENT'
     ELSE 'INCONCLUSIVE' END RESULT
FROM PHOTOS I GROUP BY PHOTO1, IRIS1, IRIS2
),
-- Status of comparison is OK when irises are correctly identified as SAME or DIFFERENT 
IRIS_RES AS (
SELECT 
    R.*, CASE   WHEN (IRIS1=IRIS2 AND RESULT='SAME') OR (IRIS1!=IRIS2 AND RESULT='DIFFERENT') THEN 'OK'
                WHEN (IRIS1=IRIS2 AND RESULT='DIFFERENT') OR (IRIS1!=IRIS2 AND RESULT='SAME') THEN 'NOT OK'
                ELSE 'UNCONFIRMED' END STATUS
FROM PHOTO_RES R
)
SELECT
    (SELECT SAME_MIN FROM PARAM) SAME_MIN, 
    (SELECT SAME_MAX FROM PARAM) SAME_MAX, 
    (SELECT DIFF_MIN FROM PARAM) DIFF_MIN, 
    (SELECT DIFF_MAX FROM PARAM) DIFF_MAX,
    (SELECT PERSON_MAX FROM PARAM) NUM_OF_PERSONS,
    (SELECT PHOTO_MAX FROM PARAM) NUM_OF_PHOTOS,
    (SELECT COUNT(*) FROM IRIS_RES) TOTAL_IRIS_COUNT,
    (SELECT COUNT(*) FROM IRIS_RES WHERE STATUS='OK' AND RESULT='SAME') COUNT_SAME_OK,
    (SELECT COUNT(*) FROM IRIS_RES WHERE STATUS='OK' AND RESULT='DIFFERENT') COUNT_DIFFERENT_OK,
    (SELECT COUNT(*) FROM IRIS_RES WHERE STATUS='OK') COUNT_OK,
    (SELECT COUNT(*) FROM IRIS_RES WHERE STATUS='NOT OK') COUNT_NOT_OK,
    (SELECT COUNT(*) FROM IRIS_RES WHERE STATUS!='UNCONFIRMED') COUNT_DEFINITIVE,
    ROUND(100.*(SELECT COUNT(*) FROM IRIS_RES WHERE STATUS='OK')/(SELECT COUNT(*) FROM IRIS_RES), 2) PCT_COUNT_OK,
    ROUND(100.*(SELECT COUNT(*) FROM IRIS_RES WHERE STATUS='NOT OK')/(SELECT COUNT(*) FROM IRIS_RES), 2) PCT_COUNT_NOT_OK,
    ROUND(100.*(SELECT COUNT(*) FROM IRIS_RES WHERE STATUS!='UNCONFIRMED')/(SELECT COUNT(*) FROM IRIS_RES), 2) PCT_DEFINITIVE

;

